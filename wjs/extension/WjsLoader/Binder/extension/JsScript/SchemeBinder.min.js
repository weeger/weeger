// @require JsScript > SchemeWebCom
// @require JsMethod > inheritLinage
// @require JsMethod > arrayDeleteItem
(function(k){k.register("WebComScheme","SchemeBinder",{classExtends:"WebCom",type:"Binder",variables:{listeners:{},statesVars:{},stateConnected:{},stateListener:{},formulaVarListenersCounter:{}},states:{},options:{cssClasses:{define:function(a,b){b=b||[];if(a.loader.classLists[a.typeGlobal])return b.concat(a.loader.classLists[a.typeGlobal])}},cssFadeIn:{define:function(a,b,c){var d=0,e,g=a.loader;e=g.protoName(a.type);var f=g.domStyle[e];if(f)for(;e=g.classLists[a.typeGlobal][d++];)a.cssRulesClassSearch(f.sheet,
e)&&(a.classLoads.typeGlobal=!0);return this.__super("define",[a,b,c])}}},__construct:function(a){var b=this.loader.webCompSchemes[this.protoClassName];if(b.callbacks&&b.callbacks.domListen)for(var c=0,d=Object.keys(b.callbacks.domListen);b=d[c++];)b=this.methodName("callbacks.domListen."+b),this[b]=this[b].bind(this);this.__super("__construct",arguments);this.wjs.inheritLinage(this,"states")},callbackFind:function(a,b){return"function"===typeof a?a:this.method("callbacks."+b+"."+a)},domChildFill:function(a,
b){this.__super("domChildFill",arguments);this.trigger("domChildFill",[a,b])},domChildRemove:function(a){a=this.domChildGet(a);a.parentNode.removeChild(a)},domStyleGet:function(a){return this.wjs.window.getComputedStyle(this.dom,null).getPropertyValue(a)},domRect:function(){return this.dom.getBoundingClientRect()},variableSet:function(a,b){void 0!==this[a]&&this[a].formula&&this.formulaListenAll(b,!1);b&&b.formula&&this.formulaListenAll(b);this.__super("variableSet",arguments)},formulaListenAll:function(a,
b){this.objectInspect(a,this.formulaListen.bind(this),b)},formulaListen:function(a,b,c){if(a&&a.formula&&(a=a.formula,(b=this.wjs.formula.formulas[a])&&b.eventTrigger&&this.formulaChangeCallback)){var d=this.formulaVarListenersCounter;!1===c&&0<d[a]?(d[a]--,0===d[a]&&(this.wjs.window.removeEventListener(b.eventNameUpdate,this.formulaChangeCallback),delete d[a])):(d[a]||this.wjs.window.addEventListener(b.eventNameUpdate,this.formulaChangeCallback),d[a]=d[a]||0,d[a]++)}},objectInspect:function(a,b,
c,d){d=d||0;for(var e=Object.keys(a),g=0,f,h;(f=e[g++])&&(h=b(a[f],f,c,d),!1!==h&&"object"===typeof a[f]&&a[f]&&this.objectInspect(a[f],b,c,d+1),null!==h););},stateSet:function(a,b,c){var d=this.states[a],e;if(b!==d){this.states.hasOwnProperty(a)||this.error("Trying to set undefined state "+a);e=this.callbackFind(a,"stateSet");this.states[a]=b;this.statesVars[a]=this.statesVars[a]||{};this.wjs.extendObject(this.statesVars[a],c||{});if(e)this[this.methodName("callbacks.stateSet."+a)](b,c,d);this.trigger("stateSet",
[a,b,d])}},stateGet:function(a){return this.states[a]},stateIs:function(a,b){"string"===typeof a&&(a={},a[a]=b);for(var c=0,d,e=Object.keys(a);d=e[c++];)if(this.states[d]!==a[d])return!1;return!0},stateListen:function(a,b,c,d){c=this.callbackFind(c,"stateListen");this.stateListener[a.id]=this.stateListener[a.id]||{};this.stateListener[a.id][b]=c;1===Object.keys(this.stateListener[a.id]).length&&this.listen(a,"stateSet","stateListen");d&&c.apply(this,[a,b,a.stateGet(b)])},stateForget:function(a,b,
c,d){var e=this.stateListener[a.id];c=this.callbackFind(c,"stateListen");d&&this.callbackFind(c,"stateListen").apply(this,[a,b,a.stateGet(b)]);delete e[b];0===Object.keys(e).length&&this.forget(a,"stateSet")},stateConnect:function(a,b,c,d){var e=this.stateConnected;e[a.id]=e[a.id]||{};e[a.id][b]=e[a.id][b]||[];e[a.id][b].push(c);this.stateListen(a,b,this.callbackFind("stateConnect","stateListen"),d)},stateDisconnect:function(a,b,c,d){var e=this.stateConnected;if(e=e[a.id]?e[a.id][b]:void 0)this.wjs.arrayDeleteItem(e,
c),this.stateForget(a,b,this.callbackFind("stateConnect","stateListen"),d)},listen:function(a,b,c){c=this.callbackFind(c,"listen");return!!a.listenerAdd(b,this,c)},forget:function(a,b){return!!a.listenerRemove(b,this)},hasListener:function(a,b){return this.listeners[a]&&this.listeners[a][b.id]},listenerAdd:function(a,b,c){return this.hasListener(a,b)?!1:(this.listeners[a]=this.listeners[a]||{},this.listeners[a][b.id]=c,!0)},listenerRemove:function(a,b){this.hasListener(a,b)&&(delete this.listeners[a][b.id],
0===Object.keys(this.listeners[a]).length&&delete this.listeners[a])},trigger:function(a,b){var c={},d=0,e,g=this.listeners[a]||{},f,h=Object.keys(g);b=b||[];for(b.unshift(this);f=h[d++];)(e=this.wjs.loaders.WebCom.webComList[f])&&(c[e.id]=g[f].apply(e,b));return c},domListen:function(a,b,c){this.domNodeListMap("domListen",arguments)||a.addEventListener(b,"function"===typeof c?c:this[this.methodName("callbacks.domListen."+c)])},domForget:function(a,b,c){this.domNodeListMap("domForget",arguments)||
a.removeEventListener(b,"function"===typeof c?c:this[this.methodName("callbacks.domListen."+c)])},domNodeListMap:function(a,b){var c=this,d;return b[0]instanceof c.wjs.window.NodeList?(d=c.wjs.extendObject([],b),Array.prototype.slice.call(b[0]).map(function(b){d[0]=b;c[a].apply(c,d)},this),!0):!1},callbacks:{listen:{stateListen:function(a,b,c,d){var e=this.stateListener[a.id]?this.stateListener[a.id][b]:void 0;e&&e.apply(this,[a,b,c,d])}},stateListen:{stateConnect:function(a,b,c){a=this.stateConnected[a.id]?
this.stateConnected[a.id][b]:void 0;b=0;var d,e;if(a)for(d=Object.keys(a);e=d[b++];)this.stateSet(a[e],c)}}}})})(WjsProto);